<!DOCTYPE html>
<html class="x-admin-sm">
    
    <head>
        <meta charset="UTF-8">
        <title>ğŸŒ¸æ¨±ä¹‹é—´ğŸŒ¸</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="./css/font.css">
        <link rel="stylesheet" href="./css/xadmin.css">
        <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="./js/xadmin.js"></script>
        <script src="/js/vue.min.js"></script>
        <script src="/js/axios.min.js"></script>

        <style>
            #app{
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <div class="content" id="app">
            <div class="layui-form" action="">
                <div class="layui-form-item">
                  <label class="layui-form-label"><span class="x-red">*</span>å•†å“åç§°</label>
                  <div class="layui-input-inline">
                    <input v-model="name" type="text" name="name" required  lay-verify="required" placeholder="è¯·è¾“å…¥å•†å“åç§°" autocomplete="off" class="layui-input">
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label"><span class="x-red">*</span>å•†å“å•ä»·</label>
                  <div class="layui-input-inline">
                    <input v-model="price" type="number" name="price" required lay-verify="required" placeholder="è¯·è¾“å…¥å•†å“å•ä»·" autocomplete="off" class="layui-input">
                  </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="x-red">*</span>å•†å“æ€»é‡</label>
                    <div class="layui-input-inline">
                      <input v-model="amount" type="number" name="amount" required lay-verify="required" placeholder="è¯·è¾“å…¥å•†å“æ€»é‡" autocomplete="off" class="layui-input">
                    </div>
                  </div>
                <div class="layui-form-item">
                  <label class="layui-form-label"><span class="x-red">*</span>å•†å“åˆ†ç±»</label>
                  <div class="layui-input-inline">
                    <select  name="categoryId" lay-verify="required">
                        <option :value="category.id" v-for="category in categorys" :key="category.id">{{category.name}}</option>
                    </select>
                  </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span class="x-red">*</span>å•†å“å›¾ç‰‡</label>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn" id="upload">
                            <i class="layui-icon">&#xe67c;</i>ä¸Šä¼ å›¾ç‰‡
                        </button>
                    </div>
                </div>
                <div style="display: flex;margin-left: 110px;margin-bottom: 20px;">
                  <div v-for="(url,index) in images" :key="index" style="position: relative;">
                    <div @click="imgDelete(index,url)" style="background: red;position: absolute;right: 5px;top: -5px;border-radius: 10px;padding: 0 1px;cursor: pointer;">
                        <i style="color: white;" class="layui-icon layui-icon-close"></i>
                    </div>
                    <img style="width: 100px;height: 100px;margin-right: 10px;"  :src="url" alt="">
                  </div>
                </div>
                <div class="layui-form-item layui-form-text">
                  <label class="layui-form-label"><span class="x-red">*</span>å•†å“æè¿°</label>
                  <div class="layui-input-inline">
                    <textarea v-model="desc" style="width: 190px;" required lay-verify="required"  name="desc" placeholder="è¯·è¾“å…¥å•†å“æè¿°" class="layui-textarea"></textarea>
                  </div>
                </div>
                <div class="layui-form-item">
                  <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="add">ç«‹å³æäº¤</button>
                  </div>
                </div>
              </div>
        </div>
        <script src="./js/config.js"></script>
        <script>
          //æå‰è®©selectç»„ä»¶æ˜¾ç¤ºå‡ºæ¥
          layui.use(['form', 'layer'],
            function() {
                $ = layui.jquery;
                var form = layui.form,
                layer = layui.layer;


                //ç›‘å¬æäº¤
                form.on('submit(add)',function(data) {
                    const fields = data.field
                    app.categoryId = fields.categoryId

                    
                    app.save()

                    return false;
                });

            }
          )
        </script>
        <script>
            const app = new Vue({
                el:'#app',
                data:{
                    categorys:[],
                    name:'',
                    price:0.0,
                    amount:0,
                    desc:'',
                    categoryId:1,
                    images:[]
                },
                beforeCreate(){
                    //è·å–æ‰€æœ‰å•†å“åˆ†ç±»
                    Http.get('/category/').then(res=>{
                        const data = res.data
                        this.categorys = data.data
                    })
                },
                methods:{
                  //å›¾ç‰‡åˆ é™¤
                  imgDelete(index,url){
                        Http.post('/file/delete',{
                            url
                        }).then(res=>{
                            console.log(res.data)
                            this.images.splice(index,1)
                        })
                   },

                  //æ·»åŠ å•†å“
                  save(){
                    Http.post('/product/add',{
                      name:this.name,
                      price:this.price,
                      amount:this.amount,
                      desc:this.desc,
                      categoryId:this.categoryId,
                      images:this.images
                    }).then(res=>{
                        const data = res.data
                        console.log(data)

                        //å…³é—­å½“å‰frame
                        xadmin.close();

                        // å¯ä»¥å¯¹çˆ¶çª—å£è¿›è¡Œåˆ·æ–° 
                        xadmin.father_reload();
                    })
                  }
                }
            })

        </script>

        <script>
            //å›¾ç‰‡ä¸Šä¼ 
            layui.use('upload', function(){
                var upload = layui.upload
            
                //æ‰§è¡Œå®ä¾‹
                var uploadInst = upload.render({
                    elem: '#upload', //ç»‘å®šå…ƒç´ 
                    url: '/api/v1/file/upload', //ä¸Šä¼ æ¥å£
                    done: function(res){
                        //ä¸Šä¼ å®Œæ¯•å›è°ƒ
                        console.log(res.data.url)
                        app.images.push(res.data.url)
                    },
                    error: function(){
                        //è¯·æ±‚å¼‚å¸¸å›è°ƒ
                    }
                })
            })
        </script>
    </body>

</html>
